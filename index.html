<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">
    <title>Document</title>
</head>
<body>
    <script>


        const parent = document.createElement('div');
        parent.id = 'parent';
        document.body.appendChild(parent);

        const TopLayerImage = document.createElement('div');
        TopLayerImage.id = 'TopLayerImage';
        parent.appendChild(TopLayerImage);

        const BottomLayer = document.createElement('div');
        BottomLayer.id = 'BottomLayer';
        parent.appendChild(BottomLayer);

        const CloseButton = document.createElement('button');
        CloseButton.id = 'CloseButton';
        CloseButton.textContent = 'X';
        parent.appendChild(CloseButton);

        //Adding JQuery to DOM
        const JQuery = document.createElement('script');
        JQuery.src = 'https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js';
        document.head.appendChild(JQuery);

        //Adding CSS file to DOM
        const CustomCSS = document.createElement('link');
        CustomCSS.rel = 'stylesheet';
        CustomCSS.href = 'https://michi19935.github.io/Warenkorb-Overlay---Git/styles.css';
        document.head.appendChild(CustomCSS);
        document.head.prepend(CustomCSS);

        const nav = document.createElement('nav');
        nav.innerHTML = `
        <ul>
            <span id="basket"><li class="Basket">Warenkorb</li><li id="basketCounter"></li></span>
            <span id="recommendations"><li class="Recommendations">Empfehlungen</li><li id="recommendationCounter"></li></span>
        </ul>
        `;
        BottomLayer.appendChild(nav);    
        
        const Items = (PImage,Title,Price,Deeplink,Type) => {
           const items = document.createElement('div');
           items.id = Type;
           items.innerHTML =  `  
            
            <div class="productImage">
                    <img src="${PImage}" alt="">
                </div>
                <div class="productDetails">
                    <div class="productTitle">${Title}</div>
                    <div class="productPrice"><b>${Price}</b></div>
                    <div class="CTAs">
                        <button class="ZumProdukt"> <a href="${Deeplink}"> Zum Produkt </a>  </button>
                        <button class="JetztKaufen" id="JetztKaufen"> <a href="https://anicanis.de/warenkorb/"> Jetzt kaufen </a> </button>
                    </div>
                </div> 
                `;
                return items
        }

        BottomLayer.appendChild(nav); 

        const GoogleFontsPoppins = document.createElement('div');
        GoogleFontsPoppins.innerHTML = `
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">`;
        document.head.appendChild(GoogleFontsPoppins);
  
                const addtoCartProductPages = () => {
                    console.log('Hi');
                    const addtoCartProductPages = document.querySelector('.single_add_to_cart_button');
                    addtoCartProductPages.addEventListener('click', (e)=>{
                    const Selectoren = ['.wd-carousel-item a img','h1.product_title','.woocommerce-Price-amount',];
                    const PImage = document.querySelector(Selectoren[0]).src;
                    const Title = document.querySelector(Selectoren[1]).innerText;
                    const Price = document.querySelector(Selectoren[2]).innerText;
                    const Deeplink = window.location.href;

                //Add Product to "Warenkorb-Section"
                const itemsParam = Items(PImage,Title,Price,Deeplink,'BasketItem');
                itemsParam.classList = 'BaskItem';
                document.querySelector('#BottomLayer').appendChild(itemsParam);
            });}


        const titlesSelect = [...document.querySelectorAll('.wd-entities-title a')];
        const titles = titlesSelect.map((title)=>{return title.innerText});

        //Determine amount of items in cart as seen in this selector
        const basketAmountString = document.querySelector('.wd-cart-number').textContent; //Z.B. "37 Artikel"
        const basketAmountNumber = basketAmountString.slice(0,2); //Z.B. "37"
        document.querySelector('#basketCounter').innerHTML = `<p>${basketAmountNumber}</p>`;

        //GetValues for Recommendations ProductPage

        const GetImagesRec = (ChromeNodes) => {
            const array = ChromeNodes.map((value)=>{return value.src});
            // Some images need to be removed from array
            const filteredArray = array.filter((word) => (!word.includes('B02') && !word.includes('b02')));
            return filteredArray
        }

        const GetPriceRec = (ChromeNodes) => {
            const array = ChromeNodes.map((value)=>{return value.innerText});
            return array
        }

        const GetTitlesRec = (ChromeNodes) => {
            const array = ChromeNodes.map((value)=>{return value.innerText});
            //Limit array to four items so RecommendationCounter shows correct value
            const shortendArray = array.slice(0,-4);
            return shortendArray
        }

        const GetDeeplinksRec = (ChromeNodes) => {
            const array = ChromeNodes.map((value)=>{return value.href});
            return array
        }

        const GetValuesRecProductPages = () => {
            const titlesRecSelect = [...document.querySelectorAll('.product-wrapper h3 a')];
            const DeeplinkRecSelect = [...document.querySelectorAll('.product-wrapper h3 a')];
            const PriceRecSelect = [...document.querySelectorAll('.product-wrapper span.price')];
            const ImageRecSelect = [...document.querySelectorAll('.related-and-upsells img.entered')];

            const PriceRec = GetPriceRec(PriceRecSelect);
            const ImageRec = GetImagesRec(ImageRecSelect);
            const DeeplinkRec = GetDeeplinksRec(DeeplinkRecSelect);
            const titlesRec = GetTitlesRec(titlesRecSelect);

            InsertRec(ImageRec, PriceRec, DeeplinkRec, titlesRec, 'RecommendationItem');
            RecommendationCounter(titlesRec);
        }

                //GetValues for Recommendations all other pages

        const GetValuesRecAllOtherPages = () => {
            const titlesRecSelectCatPage = [...document.querySelectorAll('.product-wrapper h3 a')];
            const DeeplinkRecSelectCatPage = [...document.querySelectorAll('.product-wrapper h3 a')];
            const PriceRecSelectCatPage = [...document.querySelectorAll('.product-wrapper span.price')];
            const ImageRecSelectCatPage = [...document.querySelectorAll('.product-wrapper img.entered')];

            const PriceRec = GetPriceRec(PriceRecSelectCatPage);
            const ImageRec = GetImagesRec(ImageRecSelectCatPage);
            const DeeplinkRec = GetDeeplinksRec(DeeplinkRecSelectCatPage);
            const titlesRec = GetTitlesRec(titlesRecSelectCatPage);

            InsertRec(ImageRec, PriceRec, DeeplinkRec, titlesRec, 'RecommendationItem');
            RecommendationCounter(titlesRec);
        }

        const InsertRec = (ImageRec, PriceRec, DeeplinkRec, titlesRec, Type) => {
                for(i=0; i <=5; i++){
                const RecItemsParam = Items(ImageRec[i],titlesRec[i],PriceRec[i],DeeplinkRec[i],Type);
                RecItemsParam.classList = 'RecItem';
                document.querySelector('#BottomLayer').appendChild(RecItemsParam);
            }
        }
        //Determine amount of recommendations
        const RecommendationCounter = (titlesRec) => {
            document.querySelector('#recommendationCounter').innerHTML = `<p>${titlesRec.length}</p>`;
        }

        // console.log(ImageRec[0], titlesRec[0], PriceRec[0] , 'RecommendationItem');

        if(window.location.href.includes('kategorie')){
            GetValuesRecAllOtherPages();
        } else if (!window.location.href.includes('kategorie')){
            GetValuesRecProductPages();
            addtoCartProductPages();
        }

        BottomLayer.addEventListener('click', (e)=> {
            console.log(e.target.classList);
            if(e.target.classList == 'Recommendations'){
                $('.RecItem').show();
                $('.BaskItem').hide();
            } else if (e.target.classList == 'Basket'){
                $('.RecItem').hide();
                $('.BaskItem').show();
            }
        });

        //Close Overlay - hide overlay
        document.addEventListener('click', (e) => {
            if(e.target.id=='CloseButton'){
                $(parent).hide();
            }
        })

    </script>
</body>
</html>