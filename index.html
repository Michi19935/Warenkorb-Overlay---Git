<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">
    <title>Document</title>
</head>
<body>
    <script>


        const parent = document.createElement('div');
        parent.id = 'parent';
        document.body.appendChild(parent);

        const TopLayerImage = document.createElement('div');
        TopLayerImage.id = 'TopLayerImage';
        parent.appendChild(TopLayerImage);

        const BottomLayer = document.createElement('div');
        BottomLayer.id = 'BottomLayer';
        parent.appendChild(BottomLayer);

        const CloseButton = document.createElement('button');
        CloseButton.id = 'CloseButton';
        CloseButton.textContent = 'X';
        parent.appendChild(CloseButton);

        //Adding JQuery to DOM
        const JQuery = document.createElement('script');
        JQuery.src = 'https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js';
        document.head.appendChild(JQuery);

        //Adding CSS file to DOM
        const CustomCSS = document.createElement('link');
        CustomCSS.rel = 'stylesheet';
        CustomCSS.href = 'https://michi19935.github.io/Warenkorb-Overlay---Git/styles.css';
        document.head.appendChild(CustomCSS);
        document.head.prepend(CustomCSS);

        const nav = document.createElement('nav');
        nav.innerHTML = `
        <ul>
            <span id="basket"><li class="Basket">Warenkorb</li><li id="basketCounter"></li></span>
            <span id="recommendations" class="inactive"><li class="Recommendations">Empfehlungen</li><li id="recommendationCounter"></li></span>
        </ul>
        `;
        BottomLayer.appendChild(nav);    

        //Adding div that contains all items - needed for scrollbar
        const productLayer = document.createElement('div');
        productLayer.id = 'productlayer'
        BottomLayer.appendChild(productLayer);   
        
        const Items = (PImage,Title,Price,Deeplink,Type) => {
            console.log(PImage);
           const items = document.createElement('div');
           items.id = Type;
           items.innerHTML =  `  
            
            <div class="productImage">
                    <img src="${PImage}" alt="">
                </div>
                <div class="productDetails">
                    <div class="productTitle">${Title}</div>
                    <div class="productPrice"><b>${Price}</b></div>
                    <div class="CTAs">
                        <button class="ZumProdukt" id="ZumnProdukt"> <a href="${Deeplink}"> Zum Produkt </a>  </button>
                        <button class="JetztKaufen" id="JetztKaufen"> <a href="https://anicanis.de/warenkorb/"> Jetzt kaufen </a> </button>
                    </div>
                </div> 
            `;

            document.querySelector('#productlayer').appendChild(items);
                return items
        }

        // BottomLayer.appendChild(nav); 

        const GoogleFontsPoppins = document.createElement('div');
        GoogleFontsPoppins.innerHTML = `
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">`;
        document.head.appendChild(GoogleFontsPoppins);
  
                const addtoCartProductPages = () => {
                    console.log('realllllly?');
                    const addtoCartProductPages = document.querySelector('.single_add_to_cart_button');
                    addtoCartProductPages.addEventListener('click', (e)=>{
                    const Selectoren = ['.wd-carousel-item a img','h1.product_title','.woocommerce-Price-amount',];

                    const PImage = document.querySelector(Selectoren[0]).src;
                    const Title = document.querySelector(Selectoren[1]).innerText;
                    const Price = document.querySelector(Selectoren[2]).innerText;
                    const Deeplink = window.location.href;
                    
            });}


        const titlesSelect = [...document.querySelectorAll('.wd-entities-title a')];
        const titles = titlesSelect.map((title)=>{return title.innerText});

        //Determine amount of items in cart as seen in this selector
        const basketAmountString = document.querySelector('.wd-cart-number').textContent; //Z.B. "37 Artikel"
        const basketAmountNumber = basketAmountString.slice(0,2); //Z.B. "37"
        document.querySelector('#basketCounter').innerHTML = `<p>${basketAmountNumber}</p>`;

        //GetValues for Recommendations ProductPage

        const GetImagesRec = (ChromeNodes) => {
            const array = ChromeNodes.map((value)=>{return value.getAttribute('src')});
            const filteredArray = array.filter((word) => (!word.includes('B02') && !word.includes('b02')));
            return filteredArray
        }

        const GetPriceRec = (ChromeNodes) => {
            const array = ChromeNodes.map((value)=>{return value.innerText});
            return array
        }

        const GetTitlesRec = (ChromeNodes) => {
            const array = ChromeNodes.map((value)=>{return value.innerText});
            //Limit array to four items so RecommendationCounter shows correct value
            return array
        }

        // const shortendArray = array.slice(0,-4);
        //     console.log(shortendArray)

        const GetDeeplinksRec = (ChromeNodes) => {
            const array = ChromeNodes.map((value)=>{return value.href});
            return array
        }

        const addtoCartAllOtherPages = () => {

            const CartSelect = document.querySelectorAll('.add_to_cart_button');

            console.log('Hallo von cart listener');

            CartSelect.forEach((button, index)=> {
                button.id = (`eventListener ${index}`);
                button.addEventListener('click',()=>{
                    const productID = button.getAttribute('data-product_id');
                    
                    const titlesSelect = document.querySelector(`[data-id="${productID}"] .product-wrapper h3 a`);
                    const DeeplinkSelect = document.querySelector(`[data-id="${productID}"] .product-wrapper h3 a`);
                    const PriceSelect = document.querySelector(`[data-id="${productID}"] .product-wrapper span.price`);
                    const ImageSelect = document.querySelector(`[data-id="${productID}"] .product-wrapper img.entered.lazyloaded`);

                    const PImage = ImageSelect.src;
                    const Title = titlesSelect.innerText;
                    const Price = PriceSelect.innerText;
                    const Deeplink = window.location.href;

                    //Add Product to "Warenkorb-Section"
                    AddtoOverlay(PImage,Price,Deeplink,Title,'BasketItem');
                })
            })
        }

        const GetValuesRec = () => {
            //On all other pages there are no rec items so we just take the last items on the page . therefore reverse() array
            const titlesRecSelect= [...document.querySelectorAll('.product-wrapper h3 a')].reverse();
            const DeeplinkRecSelect = [...document.querySelectorAll('.product-wrapper h3 a')].reverse();
            const PriceRecSelect = [...document.querySelectorAll('.product-wrapper span.price')].reverse();
            const ImageRecSelect = [...document.querySelectorAll('.product-wrapper img.entered.lazyloaded')].reverse();
            const amountOfImages = ImageRecSelect.length;
            //Add Product to "Recommendation-Section"
            AddtoOverlay(ImageRecSelect,PriceRecSelect,DeeplinkRecSelect,titlesRecSelect,'RecommendationItem');

            RecommendationCounter(ImageRecSelect);
        }

        const AddtoOverlay = (ImageSel,PriceSel,DeeplinkSel,TitleSel,Type) => {

            if (Type == 'RecommendationItem'){
                //Adding several items
                const PImage = GetImagesRec(ImageSel);
                console.log('amount images', PImage);
                const Price = GetPriceRec(PriceSel);
                const Deeplink = GetDeeplinksRec(DeeplinkSel);
                const Title = GetTitlesRec(TitleSel);
                InsertRec(PImage, Price, Deeplink, Title, 'RecommendationItem');
            } else if(Type == 'BasketItem') {
                //Adding only one item
                const itemsParam = Items(ImageSel,TitleSel,PriceSel,DeeplinkSel,'BasketItem');
                itemsParam.classList = Type;
                document.querySelector('#BottomLayer').appendChild(itemsParam);
            }

        };

        const InsertRec = (ImageRec, PriceRec, DeeplinkRec, titlesRec, Type) => {
                for(i=0; i <=5; i++){
                const RecItemsParam = Items(ImageRec[i],titlesRec[i],PriceRec[i],DeeplinkRec[i],Type);
                RecItemsParam.classList = 'RecItem';
                document.querySelector('#productlayer').appendChild(RecItemsParam);
            }
        }

        //Determine amount of recommendations
        const RecommendationCounter = (ImageRecSelect) => {
            document.querySelector('#recommendationCounter').innerHTML = `<p>${ImageRecSelect.length}</p>`;
        }

        if(window.location.href.includes('produkte')){
            GetValuesRec(productLayer);
            addtoCartProductPages(productLayer);
        } else {
            GetValuesRec(productLayer);
            addtoCartAllOtherPages(productLayer);
        }

        BottomLayer.addEventListener('click', (e)=> {
            if(e.target.classList == 'Recommendations'){
                $('.RecItem').show();
                $('.BaskItem').hide();
                $('#basket').addClass('inactive');
                $('#recommendations').removeClass('inactive');
            } else if (e.target.classList == 'Basket'){
                $('.RecItem').hide();
                $('.BaskItem').show();
                $('#recommendations').addClass('inactive');
                $('#basket').removeClass('inactive');
            }
        });

        //Close Overlay - hide overlay
        document.addEventListener('click', (e) => {
            if(e.target.id=='CloseButton'){
                $(parent).hide();
            }
        })

    </script>
</body>
</html>